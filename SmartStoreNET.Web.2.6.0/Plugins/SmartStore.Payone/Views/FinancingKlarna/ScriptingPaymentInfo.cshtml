@model SmartStore.Payone.Models.FinancingKlarnaPaymentInfoModel

<script type="text/javascript">
	$(function () {
		var count = 0;

		if (typeof Klarna === 'undefined') {
			loadAsync('https://cdn.klarna.com/public/kitt/core/v1.0/js/klarna.min.js');
			loadAsync('https://cdn.klarna.com/public/kitt/toc/v1.1/js/klarna.terms.min.js');
		}
		else {
			klarnaInit();
		}

		function klarnaInit() {
			var container = $('#PayoneKlarnaContainer');

			container.find('#consentxx').empty();
			container.find('#invoicexx').empty();

			new Klarna.Terms.Invoice({
				el: 'invoicexx',
				eid: '@Model.MerchantId',
				locale: '@Model.LanguageCulture',
				charge: @Model.PaymentFeeFormatted,
				type: '@(Model.IsMobileDevice ? "mobile" : "desktop")'
			});

			new Klarna.Terms.Consent({
				el: 'consentxx',
				eid: '@Model.MerchantId',
				locale: '@Model.LanguageCulture',
				type: '@(Model.IsMobileDevice ? "mobile" : "desktop")'
			});
		}

		function loadAsync(url) {
			var elem = document.createElement('script'),
				s = document.getElementsByTagName('script')[0];

			elem.type = 'text/javascript';
			elem.async = true;
			elem.src = url;

			elem.addEventListener('load', function (e) {
				if ((++count) >= 2) {
					klarnaInit();
				}
			}, false);

			s.parentNode.insertBefore(elem, s);
		}
	});
</script>
